<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kamera HD + Preview + Anti Pecah</title>
  <style>
    body {
      background: #121212;
      color: #ffffff;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      padding: 20px;
    }
    video {
      width: 90%;
      max-width: 600px;
      background: black;
      border-radius: 10px;
      object-fit: contain;
      transform-origin: center;
      transition: transform 0.3s ease;
      will-change: transform;
      backface-visibility: hidden;
    }
    input[type="range"] {
      width: 300px;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      background-color: #1f1f1f;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #333;
    }
    a {
      color: #4caf50;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Kamera HD + Zoom + Flash + Preview</h2>

  <video id="preview" autoplay muted playsinline></video>

  <div>
    <label>Zoom:</label>
    <input type="range" id="zoomControl" min="1" max="3" step="0.01" value="1">
  </div>

  <div>
    <button id="flipCamBtn">Ganti Kamera</button>
    <button id="mirrorBtn">Flip Horizontal</button>
    <button id="flashBtn">Toggle Flash</button>
  </div>

  <div>
    <button id="startBtn">Mulai Rekam</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div id="status">Status: Siap</div>
  <a id="downloadLink" style="display:none;" download="rekaman.mp4">Download Rekaman</a>

  <h3>Preview Hasil Rekaman:</h3>
  <video id="recordedPreview" controls style="display:none;"></video>

  <script>
    let mediaRecorder;
    let recordedBlobs = [];
    let videoTrack;
    let stream;
    let usingFrontCamera = true;
    let isMirrored = false;
    let isTorchOn = false;

    const preview = document.getElementById('preview');
    const zoomControl = document.getElementById('zoomControl');
    const downloadLink = document.getElementById('downloadLink');
    const statusText = document.getElementById('status');
    const recordedPreview = document.getElementById('recordedPreview');

    let currentZoom = 1;
    let targetZoom = 1;

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function animateZoom() {
      if (!videoTrack) return;
      const diff = Math.abs(currentZoom - targetZoom);
      if (diff < 0.001) {
        currentZoom = targetZoom;
      } else {
        currentZoom = lerp(currentZoom, targetZoom, 0.05);
      }
      videoTrack.applyConstraints({ advanced: [{ zoom: currentZoom }] }).catch(() => {});
      requestAnimationFrame(animateZoom);
    }

    async function startCamera() {
      if (stream) stream.getTracks().forEach(track => track.stop());

      const constraints = {
        audio: true,
        video: {
          facingMode: usingFrontCamera ? 'user' : 'environment',
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          frameRate: { ideal: 30, max: 60 },
          zoom: true,
          torch: true
        }
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        preview.srcObject = stream;
        videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities();

        if (capabilities.zoom) {
          zoomControl.min = capabilities.zoom.min;
          zoomControl.max = capabilities.zoom.max;
          zoomControl.step = capabilities.zoom.step || 0.01;
          currentZoom = targetZoom = videoTrack.getSettings().zoom || 1;
          zoomControl.value = currentZoom;
          zoomControl.disabled = false;
          zoomControl.oninput = () => {
            targetZoom = parseFloat(zoomControl.value);
          };
          animateZoom();
        } else {
          zoomControl.disabled = true;
        }

        document.getElementById('flashBtn').style.display =
          capabilities.torch !== undefined ? 'inline' : 'none';

        preview.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
      } catch (err) {
        alert('Gagal mengakses kamera: ' + err.message);
      }
    }

    document.getElementById('startBtn').onclick = () => {
      recordedBlobs = [];
      const options = { mimeType: 'video/webm;codecs=vp9' };
      mediaRecorder = new MediaRecorder(stream, options);
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedBlobs.push(e.data);
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedBlobs, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.style.display = 'inline';
        recordedPreview.src = url;
        recordedPreview.style.display = 'block';
        statusText.textContent = 'Status: Rekaman selesai';
      };
      mediaRecorder.start();
      statusText.textContent = 'Status: Merekam...';
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
    };

    document.getElementById('stopBtn').onclick = () => {
      mediaRecorder.stop();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    };

    document.getElementById('flipCamBtn').onclick = () => {
      usingFrontCamera = !usingFrontCamera;
      startCamera();
    };

    document.getElementById('mirrorBtn').onclick = () => {
      isMirrored = !isMirrored;
      preview.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
    };

    document.getElementById('flashBtn').onclick = () => {
      if (!videoTrack) return;
      isTorchOn = !isTorchOn;
      videoTrack.applyConstraints({ advanced: [{ torch: isTorchOn }] }).catch(err => {
        alert('Flash tidak tersedia di perangkat ini.');
      });
    };

    startCamera();
  </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kamera HD + Preview + Anti Pecah</title>
  <style>
    body {
      background: #121212;
      color: #ffffff;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      padding: 20px;
    }
    video {
      width: 90%;
      max-width: 600px;
      background: black;
      border-radius: 10px;
      object-fit: contain;
      transform-origin: center;
      will-change: transform;
      backface-visibility: hidden;
    }
    input[type="range"] {
      width: 300px;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      background-color: #1f1f1f;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #333;
    }
    a {
      color: #4caf50;
      font-weight: bold;
    }
    .camera-off {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      color: #888;
    }
    .zoom-info {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
    }
    .video-container {
      position: relative;
      width: 90%;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <h2>Kamera HD + Zoom + Flash + Preview</h2>

  <div class="video-container">
    <video id="preview" autoplay muted playsinline></video>
    <div id="zoomInfo" class="zoom-info" style="display:none;">1.0x</div>
    <div id="cameraOffMessage" class="camera-off" style="display:none;">Kamera dimatikan</div>
  </div>

  <div>
    <label>Zoom:</label>
    <input type="range" id="zoomControl" min="1" max="3" step="0.01" value="1" disabled>
  </div>

  <div>
    <button id="toggleCamBtn">Matikan Kamera</button>
    <button id="flipCamBtn">Ganti Kamera</button>
    <button id="mirrorBtn">Flip Horizontal</button>
    <button id="flashBtn">Toggle Flash</button>
  </div>

  <div>
    <button id="startBtn">Mulai Rekam</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div id="status">Status: Siap</div>
  <a id="downloadLink" style="display:none;" download="rekaman.mp4">Download Rekaman</a>

  <h3>Preview Hasil Rekaman:</h3>
  <video id="recordedPreview" controls style="display:none;"></video>

  <script>
    let mediaRecorder;
    let recordedBlobs = [];
    let videoTrack;
    let stream;
    let usingFrontCamera = false; // Default kamera belakang
    let isMirrored = false;
    let isTorchOn = false;
    let isCameraActive = true;

    const preview = document.getElementById('preview');
    const cameraOffMessage = document.getElementById('cameraOffMessage');
    const zoomControl = document.getElementById('zoomControl');
    const zoomInfo = document.getElementById('zoomInfo');
    const downloadLink = document.getElementById('downloadLink');
    const statusText = document.getElementById('status');
    const recordedPreview = document.getElementById('recordedPreview');
    const toggleCamBtn = document.getElementById('toggleCamBtn');

    let currentZoom = 1;
    let targetZoom = 1;
    let maxZoom = 3;
    let minZoom = 1;
    let zoomStep = 0.1;
    let zoomAnimationFrame;
    let lastZoomTime = 0;
    const ZOOM_UPDATE_INTERVAL = 16; // ~60fps

    function updateZoomInfo() {
      zoomInfo.textContent = targetZoom.toFixed(1) + 'x';
    }

    function setZoom(newZoom) {
      newZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
      targetZoom = newZoom;
      zoomControl.value = newZoom;
      updateZoomInfo();
      
      // Apply zoom immediately without waiting for animation frame
      if (videoTrack) {
        videoTrack.applyConstraints({ advanced: [{ zoom: newZoom }] }).catch(() => {});
        currentZoom = newZoom;
      }
    }

    function zoomIn() {
      setZoom(targetZoom + zoomStep);
    }

    function zoomOut() {
      setZoom(targetZoom - zoomStep);
    }

    // Handle volume button presses
    document.addEventListener('keydown', (e) => {
      if (!isCameraActive) return;
      
      // Volume Up (keyCode 38 for Android, 175 for some browsers)
      if (e.keyCode === 38 || e.keyCode === 175) {
        e.preventDefault();
        zoomIn();
      }
      // Volume Down (keyCode 40 for Android, 174 for some browsers)
      else if (e.keyCode === 40 || e.keyCode === 174) {
        e.preventDefault();
        zoomOut();
      }
    });

    // Also handle wheel event for devices that might not trigger key events
    document.addEventListener('wheel', (e) => {
      if (!isCameraActive) return;
      e.preventDefault();
      if (e.deltaY < 0) {
        zoomIn();
      } else {
        zoomOut();
      }
    });

    async function startCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      try {
        const constraints = {
          audio: true,
          video: {
            facingMode: usingFrontCamera ? 'user' : 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            frameRate: { ideal: 30, max: 60 },
            zoom: true,
            torch: true
          }
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        preview.srcObject = stream;
        videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities();

        if (capabilities.zoom) {
          minZoom = capabilities.zoom.min;
          maxZoom = capabilities.zoom.max;
          zoomStep = capabilities.zoom.step || 0.1;
          currentZoom = targetZoom = videoTrack.getSettings().zoom || 1;
          zoomControl.min = minZoom;
          zoomControl.max = maxZoom;
          zoomControl.step = zoomStep;
          zoomControl.value = currentZoom;
          zoomControl.disabled = false;
          zoomControl.oninput = () => {
            setZoom(parseFloat(zoomControl.value));
          };
          zoomInfo.style.display = 'block';
          updateZoomInfo();
        } else {
          zoomControl.disabled = true;
          zoomInfo.style.display = 'none';
        }

        document.getElementById('flashBtn').style.display =
          capabilities.torch !== undefined ? 'inline' : 'none';

        preview.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
        
        // Tampilkan video dan sembunyikan pesan kamera mati
        preview.style.display = 'block';
        cameraOffMessage.style.display = 'none';
        
        // Aktifkan tombol yang relevan
        document.getElementById('flipCamBtn').disabled = false;
        document.getElementById('mirrorBtn').disabled = false;
        document.getElementById('flashBtn').disabled = false;
        document.getElementById('startBtn').disabled = false;
        
        isCameraActive = true;
        toggleCamBtn.textContent = 'Matikan Kamera';
        statusText.textContent = 'Status: Siap';
      } catch (err) {
        alert('Gagal mengakses kamera: ' + err.message);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        preview.srcObject = null;
        
        // Sembunyikan video dan tampilkan pesan kamera mati
        preview.style.display = 'none';
        cameraOffMessage.style.display = 'flex';
        zoomInfo.style.display = 'none';
        
        // Nonaktifkan tombol yang relevan
        document.getElementById('flipCamBtn').disabled = true;
        document.getElementById('mirrorBtn').disabled = true;
        document.getElementById('flashBtn').disabled = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
        zoomControl.disabled = true;
        
        isCameraActive = false;
        toggleCamBtn.textContent = 'Hidupkan Kamera';
        statusText.textContent = 'Status: Kamera dimatikan';
      }
    }

    document.getElementById('startBtn').onclick = () => {
      if (!isCameraActive) return;
      
      recordedBlobs = [];
      const options = { mimeType: 'video/webm;codecs=vp9' };
      mediaRecorder = new MediaRecorder(stream, options);
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedBlobs.push(e.data);
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedBlobs, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.style.display = 'inline';
        recordedPreview.src = url;
        recordedPreview.style.display = 'block';
        statusText.textContent = 'Status: Rekaman selesai';
      };
      mediaRecorder.start();
      statusText.textContent = 'Status: Merekam...';
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
    };

    document.getElementById('stopBtn').onclick = () => {
      mediaRecorder.stop();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    };

    document.getElementById('flipCamBtn').onclick = () => {
      usingFrontCamera = !usingFrontCamera;
      startCamera();
    };

    document.getElementById('mirrorBtn').onclick = () => {
      isMirrored = !isMirrored;
      preview.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
    };

    document.getElementById('flashBtn').onclick = () => {
      if (!videoTrack) return;
      isTorchOn = !isTorchOn;
      videoTrack.applyConstraints({ advanced: [{ torch: isTorchOn }] }).catch(err => {
        alert('Flash tidak tersedia di perangkat ini.');
      });
    };

    toggleCamBtn.onclick = () => {
      if (isCameraActive) {
        stopCamera();
      } else {
        startCamera();
      }
    };

    // Mulai dengan kamera belakang saat pertama kali dibuka
    startCamera();
  </script>
</body>
</html>