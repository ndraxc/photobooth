<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kamera Rekam + Zoom + Flip</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 20px;
    }

    video {
      max-width: 100%;
      border-radius: 10px;
      transform-origin: center;
      transition: transform 0.3s ease;
    }

    input[type="range"] {
      width: 300px;
    }

    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #2980b9;
    }

    a {
      margin-top: 10px;
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Kamera Rekam + Zoom + Flip</h2>
  <video id="preview" autoplay muted playsinline></video>

  <div>
    <label>Zoom:</label>
    <input type="range" id="zoomControl" min="1" max="3" step="0.01" value="1">
  </div>

  <div>
    <button id="flipCamBtn">Ganti Kamera</button>
    <button id="mirrorBtn">Flip Vertikal</button>
  </div>

  <div>
    <button id="startBtn">Mulai Rekam</button>
    <button id="stopBtn">Stop</button>
  </div>

  <a id="downloadLink" style="display:none;" download="rekaman.webm">Download Rekaman</a>
  <video id="recordedVideo" controls style="display:none;"></video>

  <script>
    let mediaRecorder;
    let recordedBlobs = [];
    let videoTrack;
    let stream;
    let usingFrontCamera = true;
    let isMirrored = false;

    const preview = document.getElementById('preview');
    const recordedVideo = document.getElementById('recordedVideo');
    const zoomControl = document.getElementById('zoomControl');
    const downloadLink = document.getElementById('downloadLink');

    async function startCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: {
          facingMode: usingFrontCamera ? 'user' : 'environment',
          zoom: true
        },
        audio: true
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        preview.srcObject = stream;

        videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities();

        if (capabilities.zoom) {
          zoomControl.min = capabilities.zoom.min;
          zoomControl.max = capabilities.zoom.max;
          zoomControl.step = capabilities.zoom.step || 0.01;
          zoomControl.value = videoTrack.getSettings().zoom || 1;

          zoomControl.disabled = false;
          zoomControl.addEventListener('input', () => {
            videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(zoomControl.value) }] });
          });
        } else {
          zoomControl.disabled = true;
        }

        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) recordedBlobs.push(e.data);
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedBlobs, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          recordedVideo.src = url;
          recordedVideo.style.display = 'block';
          downloadLink.href = url;
          downloadLink.style.display = 'inline';
        };

        // Reset mirror jika ganti kamera
        preview.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
      } catch (err) {
        alert('Gagal mengakses kamera: ' + err.message);
        console.error(err);
      }
    }

    document.getElementById('startBtn').onclick = () => {
      recordedBlobs = [];
      mediaRecorder.start();
    };

    document.getElementById('stopBtn').onclick = () => {
      mediaRecorder.stop();
    };

    document.getElementById('flipCamBtn').onclick = () => {
      usingFrontCamera = !usingFrontCamera;
      startCamera();
    };

    document.getElementById('mirrorBtn').onclick = () => {
      isMirrored = !isMirrored;
      preview.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
    };

    startCamera();
  </script>
</body>
</html>